% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/validation.R
\name{export_validation_flags}
\alias{export_validation_flags}
\title{Export Validation Flags to MongoDB}
\usage{
export_validation_flags(
  conf = NULL,
  asset_id = c("surveys_v1", "surveys_v2"),
  all_flags = NULL,
  validation_statuses = NULL
)
}
\arguments{
\item{conf}{Configuration object from \code{read_config()} containing MongoDB connection
parameters and survey-specific settings}

\item{asset_id}{Character string specifying which survey to process. Must be one of
"adnap" or "lurio". Determines which configuration to use from
\code{conf$ingestion$kobo-{asset_id}}. Default is "adnap".}

\item{all_flags}{Data frame containing all validation flags with columns:
\code{submission_id}, \code{submitted_by}, \code{submission_date}, \code{alert_flag}}

\item{validation_statuses}{Data frame from \code{get_validation_status()} with columns:
\code{submission_id}, \code{validation_status}, \code{validated_by}, \code{validation_date}}
}
\value{
Invisible NULL. The function pushes data to MongoDB as a side effect.
}
\description{
Exports validation flags directly to MongoDB without updating KoboToolbox validation
statuses. This function replaces the workflow of \code{sync_validation_submissions()} to
avoid slow API updates to KoboToolbox. Instead, it uses KoboToolbox validation status
queries only to identify manually edited validations by human reviewers.
}
\details{
The function performs the following steps:
\enumerate{
\item Joins validation flags with KoboToolbox validation statuses
\item Identifies manual human approvals (excluding system username)
\item Preserves manual human decisions while updating system-generated statuses
\item Creates both wide and long format datasets for different reporting needs
\item Pushes results directly to MongoDB collections
}

\strong{Key Differences from sync_validation_submissions():}
\itemize{
\item Does NOT update validation statuses in KoboToolbox (avoids slow API calls)
\item Uses \code{validation_statuses} parameter obtained via \code{get_validation_status()}
\item Stores final validation state only in MongoDB
\item Respects manual human approvals by preserving their validation status
\item System-generated validations are updated based on current flags
}

\strong{Validation Status Logic:}
\itemize{
\item If submission has flags AND validated_by is system username: set to "not_approved"
\item If submission has no flags AND validated_by is system username: set to "approved"
\item If validated_by is NOT system username: preserve existing status (manual approval)
}
}
\note{
This function is called internally by \code{validate_surveys_adnap()} and should not
typically be called directly. It requires:
\itemize{
\item Valid configuration with MongoDB connection string
\item Survey-specific configuration under \code{conf$ingestion$kobo-{asset_id}}
\item System username configured to identify automated vs. manual validations
}
}
\section{MongoDB Collections}{

The function pushes to two MongoDB collections:
\describe{
\item{flags-{asset_id}}{Wide format with one row per submission including
validation status and flags}
\item{enumerators_stats-{asset_id}}{Long format with one row per flag per
submission for enumerator statistics}
}
}

\examples{
\dontrun{
# Called internally by validate_surveys_adnap()
export_validation_flags(
  conf = conf,
  asset_id = "surveys_v1",
  all_flags = flags_combined,
  validation_statuses = validation_statuses
)
}

}
\seealso{
\itemize{
\item \code{\link[=validate_surveys_adnap]{validate_surveys_adnap()}} for the main validation workflow
\item \code{\link[=get_validation_status]{get_validation_status()}} for fetching KoboToolbox validation status
\item \code{\link[=sync_validation_submissions]{sync_validation_submissions()}} for the deprecated approach that updates KoboToolbox
\item \code{\link[=mdb_collection_push]{mdb_collection_push()}} for MongoDB operations
}
}
\keyword{validation}
\keyword{workflow}
