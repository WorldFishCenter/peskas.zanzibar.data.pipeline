% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/merge-trips.R
\name{match_surveys_to_gps_trips}
\alias{match_surveys_to_gps_trips}
\title{Match Catch Surveys to GPS Trips}
\usage{
match_surveys_to_gps_trips(
  surveys,
  trips,
  registry = NULL,
  reg_threshold = 0.15,
  name_threshold = 0.25
)
}
\arguments{
\item{surveys}{Data frame containing:
\itemize{
\item submission_id: Unique survey identifier
\item landing_date: Date of landing
\item Boat identifiers: registration_number (or variants), boat_name, fisher_name (or captain)
}}

\item{trips}{Data frame containing:
\itemize{
\item trip: Unique trip identifier
\item imei: Device identifier
\item ended: Trip end timestamp
\item Boat identifiers: registration_number (or variants), boat_name, fisher_name (or captain)
}}

\item{registry}{Optional data frame with device-boat mappings containing:
\itemize{
\item imei: Device identifier
\item Boat identifiers: registration_number (or variants), boat_name, fisher_name (or captain)
}
If NULL, will be constructed from trips data (Zanzibar approach).}

\item{reg_threshold}{Numeric. Maximum normalized Levenshtein distance (0-1)
for registration number fuzzy matching. Default is 0.15 (15\% difference allowed).}

\item{name_threshold}{Numeric. Maximum normalized Levenshtein distance (0-1)
for boat name and fisher name fuzzy matching. Default is 0.25 (25\% difference allowed).}
}
\value{
Data frame combining matched and unmatched records with columns:
\itemize{
\item submission_id: Survey identifier (NA for unmatched trips)
\item landing_date: Landing date
\item imei: Device identifier
\item n_fields_used: Number of fields available for matching (0-3)
\item n_fields_ok: Number of fields that matched within threshold
\item match_ok: Logical indicating successful match (at least 1 field matched)
\item trip: GPS trip identifier (NA for unmatched surveys)
\item started, ended: Trip timestamps
\item registration_number_survey, registration_number_trip: For comparison
\item boat_name_survey, boat_name_trip: For comparison
\item fisher_name_survey, fisher_name_trip: For comparison
\item boat, duration_seconds, range_meters, distance_meters: Trip metadata
\item Additional trip columns (gear, community, etc.)
}
}
\description{
Universal two-step matching workflow that links catch survey records to GPS
trip data via device identifiers (IMEI). Works for both Kenya and Zanzibar
by accepting either an explicit device registry or constructing an implicit
one from the trips data.
}
\details{
The function implements a two-step matching process:

\strong{Step 1: Survey -> Registry (IMEI Assignment)}
\enumerate{
\item Standardizes column names across datasets
\item Cleans text fields (lowercase, remove punctuation, normalize whitespace)
\item Uses fuzzy matching (Levenshtein distance) on registration number, boat name, and fisher name
\item Assigns each survey to the registry entry with the most matching fields
\item Requires at least 1 field to match within threshold (match_ok = TRUE)
}

\strong{Step 2: IMEI -> Trips (Date Matching)}
\enumerate{
\item Joins surveys to trips by IMEI and landing_date
\item Only creates matches when there is exactly ONE survey and ONE trip per IMEI-date
\item Records with multiple trips/surveys per day remain unmatched
\item Preserves all unmatched surveys and trips in the output
}
}
\section{Matching Thresholds}{

The normalized Levenshtein distance ranges from 0 (exact match) to 1 (completely different):
\itemize{
\item reg_threshold = 0.15: Allows ~15\% character differences in registration numbers
\item name_threshold = 0.25: Allows ~25\% character differences in names
}
}

\section{Site-Specific Usage}{

\describe{
\item{Kenya}{Uses explicit device registry from Airtable/PDS}
\item{Zanzibar}{Builds implicit registry from historical trip data (registry = NULL)}
}
}

\examples{
\dontrun{
# Kenya: With explicit device registry
results <- match_surveys_to_gps_trips(
  surveys = kefs_surveys,
  trips = pds_trips,
  registry = devices
)

# Zanzibar: Without explicit registry (builds from trips)
results <- match_surveys_to_gps_trips(
  surveys = wf_surveys,
  trips = pds_trips,
  registry = NULL
)

# With custom thresholds
results <- match_surveys_to_gps_trips(
  surveys = surveys,
  trips = trips,
  registry = devices,
  reg_threshold = 0.10,  # Stricter registration matching
  name_threshold = 0.30  # More lenient name matching
)
}

}
\keyword{matching}
\keyword{workflow}
